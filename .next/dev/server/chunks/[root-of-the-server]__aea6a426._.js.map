{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carlo/Documents/Enter%20tech%20school/modulo301/atix-smartmail-ia/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/carlo/Documents/Enter%20tech%20school/modulo301/atix-smartmail-ia/pages/api/emails/import.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport { prisma } from \"@/lib/prisma\";\nimport { z } from \"zod\";\n\nconst EmailItemSchema = z.object({\n  id: z.string(),\n  email: z.string().email(),\n  received_at: z.string().refine((v) => !Number.isNaN(Date.parse(v)), {\n    message: \"received_at must be an ISO date\",\n  }),\n  subject: z.string(),\n  body: z.string(),\n});\n\nconst ImportPayloadSchema = z.array(EmailItemSchema).min(1);\n\nconst DEMO_USER_EMAIL = \"demo@local\";\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\n\n  try {\n    const parsed = ImportPayloadSchema.safeParse(req.body);\n    if (!parsed.success) {\n      return res.status(400).json({ error: \"Invalid JSON payload\", details: parsed.error.flatten() });\n    }\n\n    const user = await prisma.user.upsert({\n      where: { email: DEMO_USER_EMAIL },\n      update: {},\n      create: { email: DEMO_USER_EMAIL, name: \"Demo User\" },\n    });\n\n    const data = parsed.data.map((e, idx) => ({\n      userId: user.id,\n      externalId: e.id,\n      sender: e.email,\n      receivedAt: new Date(e.received_at),\n      subject: e.subject,\n      body: e.body,\n      processed: false,\n      category: null,\n      priority: null,\n      hasTask: false,\n      taskDescription: null,\n      kanbanStatus: \"todo\",\n      kanbanOrder: idx,\n    }));\n\n    // Avoid duplicates by externalId per user\n    // CreateMany doesn't support skipDuplicates on Postgres, so insert individually with upsert\n    let created = 0;\n    for (const item of data) {\n      await prisma.email.upsert({\n        where: { externalId_userId: { externalId: item.externalId, userId: item.userId } },\n        update: item,\n        create: item,\n      });\n      created += 1;\n    }\n\n    return res.status(200).json({ ok: true, imported: created });\n  } catch (err) {\n    return res.status(500).json({ error: \"Server error\", details: String(err) });\n  }\n}"],"names":[],"mappings":";;;;AACA;AACA;;;;;;;AAEA,MAAM,kBAAkB,2GAAC,CAAC,MAAM,CAAC;IAC/B,IAAI,2GAAC,CAAC,MAAM;IACZ,OAAO,2GAAC,CAAC,MAAM,GAAG,KAAK;IACvB,aAAa,2GAAC,CAAC,MAAM,GAAG,MAAM,CAAC,CAAC,IAAM,CAAC,OAAO,KAAK,CAAC,KAAK,KAAK,CAAC,KAAK;QAClE,SAAS;IACX;IACA,SAAS,2GAAC,CAAC,MAAM;IACjB,MAAM,2GAAC,CAAC,MAAM;AAChB;AAEA,MAAM,sBAAsB,2GAAC,CAAC,KAAK,CAAC,iBAAiB,GAAG,CAAC;AAEzD,MAAM,kBAAkB;AAET,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IAErF,IAAI;QACF,MAAM,SAAS,oBAAoB,SAAS,CAAC,IAAI,IAAI;QACrD,IAAI,CAAC,OAAO,OAAO,EAAE;YACnB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;gBAAwB,SAAS,OAAO,KAAK,CAAC,OAAO;YAAG;QAC/F;QAEA,MAAM,OAAO,MAAM,uHAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACpC,OAAO;gBAAE,OAAO;YAAgB;YAChC,QAAQ,CAAC;YACT,QAAQ;gBAAE,OAAO;gBAAiB,MAAM;YAAY;QACtD;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,MAAQ,CAAC;gBACxC,QAAQ,KAAK,EAAE;gBACf,YAAY,EAAE,EAAE;gBAChB,QAAQ,EAAE,KAAK;gBACf,YAAY,IAAI,KAAK,EAAE,WAAW;gBAClC,SAAS,EAAE,OAAO;gBAClB,MAAM,EAAE,IAAI;gBACZ,WAAW;gBACX,UAAU;gBACV,UAAU;gBACV,SAAS;gBACT,iBAAiB;gBACjB,cAAc;gBACd,aAAa;YACf,CAAC;QAED,0CAA0C;QAC1C,4FAA4F;QAC5F,IAAI,UAAU;QACd,KAAK,MAAM,QAAQ,KAAM;YACvB,MAAM,uHAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBACxB,OAAO;oBAAE,mBAAmB;wBAAE,YAAY,KAAK,UAAU;wBAAE,QAAQ,KAAK,MAAM;oBAAC;gBAAE;gBACjF,QAAQ;gBACR,QAAQ;YACV;YACA,WAAW;QACb;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAM,UAAU;QAAQ;IAC5D,EAAE,OAAO,KAAK;QACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;YAAgB,SAAS,OAAO;QAAK;IAC5E;AACF"}}]
}